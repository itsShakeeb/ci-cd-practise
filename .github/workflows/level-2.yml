name: CI Level 2

on:
    pull_request:
        paths-ignore:
            - 'Readme.md'
            - 'docs/**'
            - '*.md'

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node: [20, 22]
        steps:
          - uses: actions/checkout@v4

          - uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node }}
              cache: npm

          - run: npm ci
          - run: npm run lint
          - run: npm run test
          - run: npm run coverage

          - name: Upload Coverage Artifacts
            uses: actions/upload-artifact@v4
            with:
                name: coverage-${{ matrix.node }}
                path: coverage/

          - name: Generate Coverage Summary
            uses: irongut/CodeCoverageSummary@v1.3.0
            with:
                filename: coverage/lcov.info
                badge: true
                format: markdown
                output: both
            
          - name: Post Coverage Comment
            uses: marocchino/sticky-pull-request-comment@v2
            with:
                recreate: true
                path: code-coverage-results.md

